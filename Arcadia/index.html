<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcadia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1b1b1b;
            --bg-tab: #222222;
            --text-primary: #e5e5e5;
            --text-secondary: #757575;
            --accent-color: #703efb;
            --accent-hover: #a556ff;
            --border-color: #2b2b2b;
        }
        .script-hub-section {
  padding: 2rem;
}

.side-bar .icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .editor-tabs .tab span.file-icon {
            margin-right: 0.5rem;
        }

.search-container {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
}

#script-search, #script-mode {
  padding: 0.5rem;
  border: 1px solid var(--border-color);
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  border-radius: 5px;
}

#script-search {
    padding: 0.5rem; /* Ursprüngliche Padding-Größe */
    border: 1px solid var(--border-color); /* Konsistenz mit anderen Elementen */
    background-color: var(--bg-secondary); /* Gleicher Hintergrund wie der Rest */
    color: var(--text-primary); /* Gleicher Textstil wie der Rest */
    border-radius: 5px; /* Ursprünglicher Radius */
    font-size: 0.9rem; /* Passt zur ursprünglichen Größe */
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Einheitliche Schriftart */
    box-sizing: border-box; /* Wichtig für exakte Größenberechnung */
    width: 100%; /* Gleiche Breite wie andere Elemente */
    flex-grow: 1; /* Ermöglicht, dass es den Platz in der Suchleiste nutzt */
    transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}

#script-search:focus {
    outline: none;
    border-color: var(--accent-color); /* Gleicher Fokus-Stil wie andere Elemente */
    background-color: var(--bg-primary);
}

.results {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    overflow-y: auto;
    max-height: calc(100vh - 300px);
}

.results::-webkit-scrollbar {
    width: 8px;
}

.results::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 4px;
}

.results::-webkit-scrollbar-thumb:hover {
    background: var(--accent-color);
}

.script-card {
  background-color: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.2s ease-in-out;
}

.script-card:hover {
  transform: translateY(-5px);
}

.script-card img {
  width: 100%;
  height: 150px;
  object-fit: cover;
}

.header {
      -webkit-app-region: drag;
    }

.script-content-container {
  padding: 1rem;
  justify-content: space-between;
}


.script-title {
  font-size: 1.1rem;
  font-weight: bold;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  max-width: calc(100%);
}

.script-title a {
  color: var(--accent-color);
  text-decoration: none;
}


.script-details {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

#search-button {
  background-color: var(--accent-color);
  color: #fff;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
  float: right;
}

#search-button:hover {
  background-color: var(--accent-hover);
}

.copy-button {
  background-color: var(--accent-color);
  color: #fff;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
  float: right;
  margin-bottom: 10px;
}

.copy-button:hover {
  background-color: var(--accent-hover);
}

.load-more-button {
  display: block;
  margin: 2rem auto 0;
  background-color: var(--accent-color);
  color: #fff;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
}

.load-more-button:hover {
  background-color: var(--accent-hover);
}


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: transparent;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .window {
            display: flex;
            flex-direction: column;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .header .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            color: var(--accent-color);
            font-weight: bold;
        }

        .header .controls {
            display: flex;
            gap: 0.5rem;
        }

        .header .controls button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            transition: all 0.2s ease-in-out;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header .controls button:hover {
            background-color: var(--bg-tab);
            color: var(--text-primary);
        }

        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .side-bar {
            width: 60px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 1rem;
        }

        .side-bar .icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease-in-out;
        }

        .side-bar .icon:hover {
            background-color: var(--bg-tab);
            color: var(--text-primary);
        }

        .side-bar .icon.active {
            background-color: var(--bg-tab);
            color: var(--accent-color);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .editor-tabs {
            display: flex;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            padding: 0; /* Padding entfernen */
        }


        .editor-tabs .tab {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .editor-tabs .tab:hover {
            background-color: var(--bg-tab);
            color: var(--text-primary);
        }

        .editor-tabs .tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-color);
        }

        .editor-tabs .tab .close {
            margin-left: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .editor-tabs .tab:hover .close {
            opacity: 1;
        }

        .editor-tabs .new-tab {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    gap: 0.5rem;
}

.editor-tabs .new-tab i {
    font-size: 0.9rem;
    color: var(--text-secondary);
    transition: color 0.2s ease-in-out;
}


.editor-tabs .new-tab:hover {
    background-color: var(--bg-tab);
}

.editor-tabs .new-tab:hover i {
    color: var(--accent-color);
}

.editor-tabs .new-tab span {
    font-size: 0.9rem;
}

        .section {
            display: none;
            flex: 1;
        }

        .section.active {
            display: flex;
            flex-direction: column;
        }

        #editor {
            flex: 1;
            font-size: 14px;
            background-color: var(--bg-primary);
            position: relative;
        }

        .settings-section, .script-hub-section {
            padding: 2rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .settings-section h2, .script-hub-section h2 {
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        .settings-section .setting-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
}

.settings-section .setting-info {
    flex: 1;
}

.settings-section .setting-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.settings-section .setting-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    transition: .4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 3px;
    bottom: 3px;
    background-color: var(--text-secondary);
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
    background-color: white;
}

.toggle-slider:hover {
    border-color: var(--accent-color);
}

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }



        .footer .right-buttons {
    margin-left: auto;
}

        .footer button {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-right: 0.5rem;
        }

        .footer button:hover {
            background-color: var(--accent-color);
            color: #fff;
        }

        .footer .primary {
            background-color: var(--accent-color);
            color: #fff;
        }

        .footer .primary:hover {
            background-color: var(--accent-hover);
        }

        .window {
            background-color: var(--bg-primary);
        }
    </style>

<style>
.rapeqwdqwd {
  font-size: 24px;
  line-height: 1;
  padding: 10px;
  background: none;
  border: none;
  display: inline-block;
  text-align: center;
  font-family: Arial, sans-serif;
}

  
    .rapeqwdqwd:focus {
      outline: none;
    }

#editor ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

#editor ::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

#editor ::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 8px;
}

#editor ::-webkit-scrollbar-thumb:hover {
    background-color: #555555;
}


#toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .toast {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transform: translateX(100%);
    animation: toast-in 0.5s forwards, toast-out 0.5s 5s forwards;
  }

  @keyframes toast-in {
    from {
      opacity: 0;
      transform: translateX(100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes toast-out {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(100%);
    }
  }

  @keyframes fade-out {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@keyframes fade-in {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.fade-out {
  animation: fade-out 0.2s forwards;
}

.fade-in {
  animation: fade-in 0.2s forwards;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}
.status-dot.green { background: #4caf50; }
.status-dot.red { background: #f44336; }
.executor-port-bar {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-secondary);
    user-select: none;
    cursor: pointer;
}




  </style>
</head>
<body>
    <div class="window">
        <div id="toast-container"></div>

        <div class="header">
            <div class="logo">Arcadia</div>
            <div id="executor-port-bar" class="executor-port-bar" title="Executor"> 
                <span id="bar-executor">Hydrogen</span>
                <span id="status-dot" class="status-dot red" style="margin-left:10px;"></span>
            </div>
            <div class="controls">
                <button class="rapeqwdqwd">⎯</button>
                <button class="rapeqwdqwd">▢</button>
                <button class="rapeqwdqwd">✕</button>
            </div>
        </div>

        <div class="editor-container">

            <div class="side-bar">
                <div class="icon active" data-section="editor-section" title="Home">
                    <i class="fas fa-home"></i>
                </div>
                <div class="icon" data-section="script-hub-section" title="Script Hub">
                    <i class="fas fa-book"></i>
                </div>
                <div class="icon" data-section="settings-section" title="Settings">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
            
            <div class="main-content">
                <div class="section active" id="editor-section">
                    <div class="editor-tabs">
                        <div class="new-tab">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    
                    <div id="editor" style="display: none;"></div> 
                </div>

                <div class="section" id="script-hub-section">
                    <div class="script-hub-section">
                      <h2>Script Hub</h2>
                      <div class="search-container">
                        <input type="text" id="script-search" placeholder="Search scripts...">
                        <button id="search-button" class="primary">Search</button>
                      </div>                    
                      <div class="results" id="results"></div>
                      <button id="load-more" class="button load-more-button">Load More</button>
                    </div>
                  </div>

                  <div class="section" id="settings-section">
                    <div class="settings-section">
                        <h2>Settings</h2>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Stay on Top</div>
                                <div class="setting-description">Keep window always on top of other windows</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="alwaysOnTopToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Auto Inject</div>
                                <div class="setting-description">Arcadia is going to Inject as soon as Roblox is open</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoInjectToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Theme</div>
                                <div class="setting-description">Select your preferred theme</div>
                            </div>
                            <select id="themeSelector">
                                <option value="default">Standard Theme</option>
                                <option value="blue">Blue Theme</option>
                                <option value="red">Red Theme</option>
                                <option value="green">Green Theme</option>
                                <option value="orange">Orange Theme</option>
                            </select>
                        </div>                        

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Executor</div>
                                <div class="setting-description">Choose your Executor</div>
                            </div>
                            <select id="executorSelector">
                                <option value="hydrogen">Hydrogen</option>
                                <option value="macsploit">MacSploit</option>
                            </select>
                        </div>

                        <!-- Port/URL inputs removed: Hydrogen ports default to 6969-7069, MacSploit ports default to 5553-5562 -->

                    </div>
                </div>

                
            </div>
        </div>

        <div class="footer">
                <div class="left-buttons">
                                <button class="primary" onclick="sendToServer()">Execute</button>
                <button onclick="clearEditor()">Clear</button>
                <button onclick="openFile()">Open</button>
                <button onclick="saveFile()">Save</button>
                <button onclick="killRoblox()">Kill Roblox</button>
                                
            </div>
        </div>
    </div>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/theme-dracula.js"></script>
    <script src="renderer.js"></script>
    <script>       
    
    function showToast(message, duration = 4000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;

    container.appendChild(toast);

    // Entfernen der Notifikation nach der angegebenen Dauer
    const toastDuration = Math.max(1000, duration); // Mindestdauer von 1 Sekunde
    toast.style.animation = `toast-in 0.5s forwards, toast-out 0.5s ${toastDuration / 1000 - 0.5}s forwards`;

    setTimeout(() => {
        toast.remove();
    }, toastDuration);
}

    
const fileContents = {

};


ace.define("ace/theme/vs_dark_custom", ["require", "exports", "module"], function(require, exports, module) {
    const theme = {
        isDark: true,
        cssClass: "ace-vs-dark",
        cssText: `
.ace-vs-dark .ace_gutter {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border-right: 1px solid var(--border-color);
}
.ace-vs-dark {
    background-color: var(--bg-secondary);
    color: #D4D4D4;
}
.ace-vs-dark .ace_cursor {
    color: #D4D4D4;
    border-left: 2px solid #D4D4D4;
}
.ace-vs-dark .ace_marker-layer .ace_selection {
    background: rgba(75, 75, 75, 0.4);
}
.ace-vs-dark .ace_gutter-active-line {
    background-color: var(--bg-tab);
}
.ace-vs-dark .ace_marker-layer .ace_active-line {
    background: var(--bg-secondary) 
}
.ace-vs-dark .ace_keyword {
    color: #569CD6;
}
.ace-vs-dark .ace_constant {
    color: #9CDCFE;
}
.ace-vs-dark .ace_string {
    color: #CE9178;
}
.ace-vs-dark .ace_comment {
    color: #6A9955;
}
.ace-vs-dark .ace_function {
    color: #DCDCAA;
}
.ace-vs-dark .ace_variable {
    color: #9CDCFE;
}
.ace-vs-dark .ace_numeric {
    color: #B5CEA8;
}
`
    };
    return theme;
});

const editor = ace.edit("editor");
editor.setTheme("ace/theme/vs_dark_custom");
editor.session.setMode("ace/mode/lua");
editor.setValue(fileContents['main.lua']);
editor.setOptions({
    fontSize: 14,
    showGutter: true,
    highlightActiveLine: true,
    showPrintMargin: false,
    displayIndentGuides: true,
    enableBasicAutocompletion: true,
    enableLiveAutocompletion: true,
    highlightGutterLine: false,
    showLineNumbers: true,
    animatedScroll: true,
    scrollPastEnd: 0.5,
    selectionStyle: 'line',
    cursorStyle: 'smooth',
    behavioursEnabled: true
});
editor.getSession().setUseWorker(false);
editor.renderer.setOption('lineHeight', 1.6);

const editorElement = document.getElementById('editor');
editorElement.style.backgroundColor = '#1E1E1E';
editorElement.style.color = '#D4D4D4';
editorElement.style.fontFamily = "'Cascadia Code', 'Fira Code', Consolas, monospace";
editorElement.style.lineHeight = '1.6';

function setupSidebarListeners() {
    const sidebarIcons = document.querySelectorAll('.side-bar .icon');

    sidebarIcons.forEach(icon => {
        icon.addEventListener('click', () => {
            const currentActiveSection = document.querySelector('.section.active');
            const newSectionId = icon.dataset.section;
            const newSection = document.getElementById(newSectionId);

            if (currentActiveSection !== newSection) {
                // Fade out the current section
                currentActiveSection.classList.add('fade-out');

                setTimeout(() => {
                    // Hide the current section and remove fade-out
                    currentActiveSection.classList.remove('active', 'fade-out');

                    // Activate the new section
                    newSection.classList.add('active', 'fade-in');

                    // Remove fade-in after the animation
                    setTimeout(() => newSection.classList.remove('fade-in'), 200);
                }, 200); // Match the duration of fade-out animation
            }

            // Update active icon
            sidebarIcons.forEach(i => i.classList.remove('active'));
            icon.classList.add('active');
        });
    });
}


function updateEditorVisibility() {
    const editorContainer = document.getElementById('editor');
    const tabs = document.querySelectorAll('.editor-tabs .tab:not(.new-tab)');
    
    if (tabs.length === 0) {
        editorContainer.style.display = 'none';
    } else {
        editorContainer.style.display = 'block';
    }
}

function setupTabSwitchListeners() {
    document.querySelectorAll('.editor-tabs .tab:not(.new-tab)').forEach(tab => {
        tab.addEventListener('click', (e) => {
            if (e.target.classList.contains('close')) return;

            const currentActiveTab = document.querySelector('.editor-tabs .tab.active');
            if (currentActiveTab) {
                fileContents[currentActiveTab.dataset.file] = editor.getValue();
                currentActiveTab.classList.remove('active');
            }

            tab.classList.add('active');

            const fileName = tab.dataset.file;
            editor.setValue(fileContents[fileName] || '');
            editor.clearSelection();
            editor.focus();
        });
    });
}

function setupTabCloseListeners() {
    document.querySelectorAll('.editor-tabs .tab .close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const tab = closeBtn.closest('.tab');
            const fileName = tab.dataset.file;

            // Entferne Tab-Inhalt
            delete fileContents[fileName];

            // Wechsel zu einem anderen Tab oder verberge den Editor
            if (tab.classList.contains('active')) {
                const nextTab = tab.nextElementSibling;
                const prevTab = tab.previousElementSibling;

                if (nextTab && !nextTab.classList.contains('new-tab')) {
                    nextTab.click();
                } else if (prevTab && !prevTab.classList.contains('new-tab')) {
                    prevTab.click();
                } else {
                    editor.setValue('');
                    editor.clearSelection();
                    editor.blur();
                    document.getElementById('editor').style.display = 'none';
                }
            }

            tab.remove();
        });
    });
}

function setupClearButton() {
    const clearButton = document.querySelector('.footer button:nth-child(2)');
    
    clearButton.addEventListener('click', () => {
        const activeTab = document.querySelector('.editor-tabs .tab.active');
        if (activeTab) {
            const fileName = activeTab.dataset.file;
            fileContents[fileName] = '';
            editor.setValue('');
            editor.clearSelection();
            editor.focus();
        }
    });
}

function setupNewTabListener() {
    const newTabButton = document.querySelector('.new-tab');

    newTabButton.addEventListener('click', () => {
        const existingTabs = document.querySelectorAll('.editor-tabs .tab:not(.new-tab)');
        const fileCount = existingTabs.length;
        const newFileName = `untitled${fileCount + 1}.lua`;

        const newTab = document.createElement('div');
        newTab.className = 'tab';
        newTab.dataset.file = newFileName;
        newTab.innerHTML = `
            <span class="file-icon"><i class="far fa-file-code"></i></span>
            <span>${newFileName}</span>
            <span class="close">×</span>
        `;

        document.querySelectorAll('.editor-tabs .tab').forEach(t => t.classList.remove('active'));

        const currentActiveTab = document.querySelector('.editor-tabs .tab.active');
        if (currentActiveTab) {
            fileContents[currentActiveTab.dataset.file] = editor.getValue();
        }

        newTabButton.parentNode.insertBefore(newTab, newTabButton);

        fileContents[newFileName] = '';

        newTab.classList.add('active');
        editor.setValue(fileContents[newFileName]);
        editor.clearSelection();
        editor.focus();

        setupTabSwitchListeners();
        setupTabCloseListeners();
        updateEditorVisibility(); 
    });

    // If there are no editor tabs on first run, create one automatically so the editor is visible.
    if (document.querySelectorAll('.editor-tabs .tab:not(.new-tab)').length === 0) {
        setTimeout(() => newTabButton.click(), 30);
    }
}

function setupScriptHub() {
    const searchForm = document.getElementById('script-search');
    const modeSelect = document.getElementById('script-mode');
    const searchButton = document.getElementById('search-button');
    const resultsDiv = document.getElementById('results');
    const loadMoreButton = document.getElementById('load-more');
    let currentPage = 1;

    async function fetchScripts(page = 1) {
    const searchInput = document.getElementById('script-search').value;

    try {
        // Prefer the bundled local API server if available
        let apiUrlBase = 'https://scriptblox-api-proxy.vercel.app';
        try {
            if (window.electron?.getApiPort) {
                const port = await window.electron.getApiPort();
                if (port) apiUrlBase = `http://127.0.0.1:${port}`;
            }
        } catch (e) {
            console.warn('Could not get local API port, falling back to external proxy', e);
        }

        // If the user hasn't entered a search query, show trending
        const endpoint = (!searchInput || searchInput.trim() === '') ? 'trending' : 'search';
        const url = `${apiUrlBase}/api/${endpoint}${endpoint === 'search' ? `?q=${encodeURIComponent(searchInput)}&page=${page}` : ''}`;

        const response = await fetch(url);
        const data = await response.json();

        // Expose base for image loading in createScriptCard
        window.__apiUrlBase = apiUrlBase;

        const resultsDiv = document.getElementById('results');
        const loadMoreButton = document.getElementById('load-more');

        if (page === 1) {
            resultsDiv.innerHTML = '';
        }

        if (data?.result?.scripts?.length) {
            data.result.scripts.forEach(script => {
                const scriptCard = createScriptCard(script);
                resultsDiv.appendChild(scriptCard);
            });
            loadMoreButton.style.display = page < data.result.totalPages ? 'block' : 'none';
        } else {
            resultsDiv.innerHTML = '<p>No scripts found.</p>';
            loadMoreButton.style.display = 'none';
        }
    } catch (error) {
        console.error('Error fetching scripts:', error);
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p>An error occurred while fetching scripts.</p>';
        const loadMoreButton = document.getElementById('load-more');
        loadMoreButton.style.display = 'none';
    }
}


    function createScriptCard(script) {
    const scriptDiv = document.createElement('div');
    scriptDiv.classList.add('script-card');
    let imageSrc = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTFV_3fgSgibO5UnL_ydawji9oIAUr6NblpEw&s';
    try {
        if (script.game && script.game.imageUrl) {
            const apiBase = window.__apiUrlBase || '';
            if (apiBase && apiBase.startsWith('http://127.0.0.1')) {
                imageSrc = `${apiBase}/api/img?path=${encodeURIComponent(script.game.imageUrl)}`;
            } else {
                imageSrc = `https://scriptblox.com${script.game.imageUrl}`;
            }
        }
    } catch (e) {
        imageSrc = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTFV_3fgSgibO5UnL_ydawji9oIAUr6NblpEw&s';
    }

    scriptDiv.innerHTML = `
        <img src="${imageSrc}" alt="Game Image" onerror="this.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTFV_3fgSgibO5UnL_ydawji9oIAUr6NblpEw&s';" />
        <h3 class="script-title"><a href="https://scriptblox.com/script/${script.slug}" target="_blank" rel="noopener noreferrer">${script.title}</a></h3>
        <div class="script-content-container">
            <div class="script-text-container">
                <button class="copy-button">Open in Editor</button>
            </div>
        </div>
    `;

    const openButton = scriptDiv.querySelector('.copy-button');
    openButton.addEventListener('click', () => {
        document.querySelectorAll('.side-bar .icon').forEach(i => i.classList.remove('active'));
        document.querySelector('[data-section="editor-section"]').classList.add('active');
        
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById('editor-section').classList.add('active');

        showToast("Opened " + script.title + ".lua", 3000)

        createNewTabWithContent(script.title + '.lua', script.script);
    });

    return scriptDiv;
}
    searchButton.addEventListener('click', () => fetchScripts(1));
    loadMoreButton.addEventListener('click', () => fetchScripts(currentPage + 1));

    fetchScripts(1);
}

function createNewTabWithContent(fileName, content) {
    const editorContainer = document.getElementById('editor');
    editorContainer.style.display = 'block';

    const tabsContainer = document.querySelector('.editor-tabs');
    const newTabButton = document.querySelector('.new-tab');
    
    const currentActiveTab = document.querySelector('.editor-tabs .tab.active');
    if (currentActiveTab) {
        fileContents[currentActiveTab.dataset.file] = editor.getValue();
        currentActiveTab.classList.remove('active');
    }
    
    const newTab = document.createElement('div');
    newTab.className = 'tab active';
    newTab.dataset.file = fileName;
    newTab.innerHTML = `
        <span class="file-icon"><i class="far fa-file-code"></i></span>
        <span>${fileName}</span>
        <span class="close">×</span>
    `;
    
    tabsContainer.insertBefore(newTab, newTabButton);
    
    fileContents[fileName] = content;
    
    editor.setValue(fileContents[fileName]);
    editor.clearSelection();
    editor.focus();
    
    setupTabSwitchListeners();
    setupTabCloseListeners();
}

document.addEventListener('DOMContentLoaded', () => {
  const minimizeButton = document.querySelector('.rapeqwdqwd:nth-child(1)');
  const maximizeButton = document.querySelector('.rapeqwdqwd:nth-child(2)');
  const closeButton = document.querySelector('.rapeqwdqwd:nth-child(3)');

  minimizeButton.addEventListener('click', minimizeWindow);
  maximizeButton.addEventListener('click', maximizeWindow);
  closeButton.addEventListener('click', closeWindow);
});

function setupThemeSelector() {
    const themeSelector = document.getElementById('themeSelector');

    // Load previously selected theme or set default
    const savedTheme = localStorage.getItem('selectedTheme') || 'default';
    themeSelector.value = savedTheme;
    applyTheme(savedTheme);

    themeSelector.addEventListener('change', (event) => {
        const selectedTheme = event.target.value;
        localStorage.setItem('selectedTheme', selectedTheme);
        applyTheme(selectedTheme);
    });
}

function applyTheme(theme) {
    if (theme === 'default') {
        document.documentElement.style.setProperty('--bg-primary', '#121212');
        document.documentElement.style.setProperty('--bg-secondary', '#1b1b1b');
        document.documentElement.style.setProperty('--bg-tab', '#222222');
        document.documentElement.style.setProperty('--text-primary', '#e5e5e5');
        document.documentElement.style.setProperty('--text-secondary', '#757575');
        document.documentElement.style.setProperty('--accent-color', '#703efb');
        document.documentElement.style.setProperty('--accent-hover', '#a556ff');
        document.documentElement.style.setProperty('--border-color', '#2b2b2b');

        editor.renderer.setStyle('ace_active-line', 'background: #2C2C2C');
    } else if (theme === 'blue') {
        document.documentElement.style.setProperty('--bg-primary', '#0a1f3d');
        document.documentElement.style.setProperty('--bg-secondary', '#0d2747');
        document.documentElement.style.setProperty('--bg-tab', '#163a61');
        document.documentElement.style.setProperty('--text-primary', '#dce6f1');
        document.documentElement.style.setProperty('--text-secondary', '#98a9c7');
        document.documentElement.style.setProperty('--accent-color', '#3399ff');
        document.documentElement.style.setProperty('--accent-hover', '#1a8cff');
        document.documentElement.style.setProperty('--border-color', '#0d3556');

        editor.renderer.setStyle('ace_active-line', 'background: #24577a');
    } else if (theme === 'red') {
        document.documentElement.style.setProperty('--bg-primary', '#3d0a0a');
        document.documentElement.style.setProperty('--bg-secondary', '#471d1d');
        document.documentElement.style.setProperty('--bg-tab', '#612020');
        document.documentElement.style.setProperty('--text-primary', '#f1d4d4');
        document.documentElement.style.setProperty('--text-secondary', '#c79898');
        document.documentElement.style.setProperty('--accent-color', '#ff3333');
        document.documentElement.style.setProperty('--accent-hover', '#ff1a1a');
        document.documentElement.style.setProperty('--border-color', '#561d1d');

        editor.renderer.setStyle('ace_active-line', 'background: #7a2424');
    } else if (theme === 'green') {
        document.documentElement.style.setProperty('--bg-primary', '#0a3d0a');
        document.documentElement.style.setProperty('--bg-secondary', '#1d471d');
        document.documentElement.style.setProperty('--bg-tab', '#206120');
        document.documentElement.style.setProperty('--text-primary', '#d4f1d4');
        document.documentElement.style.setProperty('--text-secondary', '#98c798');
        document.documentElement.style.setProperty('--accent-color', '#33ff33');
        document.documentElement.style.setProperty('--accent-hover', '#1aff1a');
        document.documentElement.style.setProperty('--border-color', '#1d561d');

        editor.renderer.setStyle('ace_active-line', 'background: #247a24');
    } else if (theme === 'orange') {
        document.documentElement.style.setProperty('--bg-primary', '#3d2a0a');
        document.documentElement.style.setProperty('--bg-secondary', '#47361d');
        document.documentElement.style.setProperty('--bg-tab', '#614820');
        document.documentElement.style.setProperty('--text-primary', '#f1e6d4');
        document.documentElement.style.setProperty('--text-secondary', '#c7b798');
        document.documentElement.style.setProperty('--accent-color', '#ff9933');
        document.documentElement.style.setProperty('--accent-hover', '#ff8c1a');
        document.documentElement.style.setProperty('--border-color', '#563f1d');

        editor.renderer.setStyle('ace_active-line', 'background: #7a5e24');
    }

    editorElement.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
    editorElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
}

function initializeApp() {
    setupSidebarListeners();
    setupTabSwitchListeners();
    setupTabCloseListeners();
    setupNewTabListener();
    setupScriptHub();
    setupClearButton();
    setupTabCloseListeners();
    setupThemeSelector();

    loadSettings();

    const settingsInputs = document.querySelectorAll('#alwaysOnTopToggle, #autoInjectToggle, #themeSelector, #executorSelector');
    settingsInputs.forEach(input => {
        input.addEventListener('change', saveSettings);
    });

    setTimeout(() => {
        showToast('Arcadia initialized successfully!', 2500);
    }, 300);
}

const style = document.createElement('style');
style.textContent = `
    .tab-rename-input {
        background: var(--bg-secondary);
        border: 1px solid var(--accent-color);
        color: var(--text-primary);
        outline: none;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: inherit;
        font-family: inherit;
    }
`;
document.head.appendChild(style);

document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
